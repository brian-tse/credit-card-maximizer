<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CardMax - My Cards Dashboard</title>
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="images/favicon-180x180.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <style>
    /* My Cards Page Specific Styles */
    .my-cards-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .search-container {
      position: relative;
      width: 100%;
      max-width: 400px;
    }

    .search-input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 2.5rem;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 1rem;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--text);
      box-shadow: 0 0 0 3px rgba(26, 26, 26, 0.05);
    }

    .search-icon {
      position: absolute;
      left: 0.875rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
    }

    /* Card Selection Grid */
    .card-selector-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .card-selector-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: var(--bg-secondary);
      border-radius: var(--radius);
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
    }

    .card-selector-item:hover {
      border-color: var(--border-color);
      background: var(--bg-card);
    }

    .card-selector-item.selected {
      border-color: var(--accent);
      background: var(--accent-light);
    }

    .card-selector-item .card-color-bar {
      width: 6px;
      height: 50px;
      border-radius: 3px;
      flex-shrink: 0;
    }

    .card-selector-item .card-details {
      flex: 1;
      min-width: 0;
    }

    .card-selector-item .card-name {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 0.25rem;
    }

    .card-selector-item .card-issuer {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
    }

    .card-selector-item .card-fee {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .card-selector-item .card-checkbox {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
    }

    .card-selector-item.selected .card-checkbox {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    /* My Cards List - Grid Layout */
    .my-cards-section {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 1.5rem;
      margin-bottom: 2rem;
      border: 1px solid var(--border);
    }

    .my-cards-section h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    #my-cards-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
    }

    .my-card-item {
      background: var(--bg);
      border-radius: var(--radius-sm);
      padding: 0.75rem;
      border: 1px solid var(--border);
      position: relative;
      transition: all 0.15s ease;
    }

    .my-card-item:hover {
      border-color: var(--text-secondary);
    }

    .my-card-item .card-visual {
      margin-bottom: 0.75rem;
    }

    .my-card-item .card-details {
      padding: 0;
    }

    .my-card-item .card-name {
      font-weight: 600;
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
    }

    .my-card-item .card-meta {
      font-size: 0.75rem;
      color: var(--text-secondary);
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .my-card-item .card-actions {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      display: flex;
      gap: 0.25rem;
      opacity: 0;
      transition: opacity 0.15s ease;
    }

    .my-card-item:hover .card-actions {
      opacity: 1;
    }

    .my-card-item .action-btn {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 4px;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 0.75rem;
      color: var(--text-secondary);
      transition: all 0.15s ease;
    }

    .my-card-item .action-btn:hover {
      background: var(--bg);
      color: var(--text);
    }

    .my-card-item .action-btn.remove:hover {
      color: var(--warning);
      border-color: var(--warning);
    }

    /* Date picker inline */
    .my-card-item .date-row {
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px dashed var(--border);
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.65rem;
      flex-wrap: wrap;
    }

    .my-card-item .date-row select {
      padding: 0.2rem 0.25rem;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-size: 0.65rem;
      font-family: inherit;
      min-width: 0;
      flex-shrink: 1;
    }

    .my-card-item .date-row label {
      color: var(--text-secondary);
      margin-right: 0.25rem;
    }

    /* Add date hint */
    .my-card-item .add-date-hint {
      color: var(--text-muted);
      font-style: italic;
      font-size: 0.7rem;
    }

    .my-card-item {
      cursor: pointer;
    }

    .my-card-item.expanded {
      border-color: var(--accent);
      background: var(--surface);
    }

    /* Save Button Area */
    .save-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
    }

    .save-status {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .save-status.saved {
      color: var(--accent);
    }

    /* Sort Selector */
    .sort-selector {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .sort-selector label {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .sort-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .sort-btn {
      padding: 0.4rem 0.75rem;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background: var(--bg-card);
      color: var(--text-secondary);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .sort-btn:hover {
      border-color: var(--text-secondary);
      color: var(--text-primary);
    }

    .sort-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    /* Auth UI Styles */
    .auth-container {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px dashed var(--border-color);
    }

    .auth-signed-in,
    .auth-signed-out {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .auth-status {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .auth-hint {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .auth-link {
      background: none;
      border: none;
      color: var(--accent);
      font-size: 0.85rem;
      cursor: pointer;
      padding: 0;
      text-decoration: underline;
    }

    .auth-link:hover {
      opacity: 0.8;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 3rem 2rem;
    }

    .empty-state h3 {
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }

    .empty-state p {
      color: var(--text-secondary);
      margin-bottom: 1.5rem;
    }

    /* Quick Stats */
    .quick-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .quick-stat-card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 1.25rem 1.5rem;
      border: 1px solid var(--border);
      transition: box-shadow 0.15s ease;
    }

    .quick-stat-card:hover {
      box-shadow: var(--shadow);
    }

    .quick-stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.5px;
    }

    .quick-stat-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="navbar-content">
      <a href="index.html" class="logo"><img src="images/favicon-32x32.png" alt="CardMax" class="logo-icon">CardMax</a>
      <ul class="nav-links">
        <li><a href="index.html" class="active">My Cards</a></li>
        <li><a href="pages/cards.html">All Cards</a></li>
        <li><a href="pages/compare.html">Compare</a></li>
      </ul>
      <div id="navbar-auth" class="navbar-auth"></div>
    </div>
  </nav>

  <!-- Sub-Navigation -->
  <nav class="sub-navbar">
    <div class="sub-navbar-content">
      <ul class="sub-nav-links">
        <li><a href="index.html" class="active">Dashboard</a></li>
        <li><a href="pages/tracker.html">Benefits</a></li>
        <li><a href="pages/categories.html">Categories</a></li>
        <li><a href="pages/partners.html">Transfer Partners</a></li>
      </ul>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container">
    <!-- Hero Section -->
    <section class="hero">
      <h1>Your Cards</h1>
      <p>Track benefits and maximize rewards</p>
    </section>

    <!-- Quick Stats -->
    <div class="quick-stats" id="quick-stats">
      <div class="quick-stat-card">
        <div class="quick-stat-value" id="stat-my-cards">0</div>
        <div class="quick-stat-label">My Cards</div>
      </div>
      <div class="quick-stat-card">
        <div class="quick-stat-value" id="stat-annual-fees">$0</div>
        <div class="quick-stat-label">Annual Fees</div>
      </div>
      <div class="quick-stat-card">
        <div class="quick-stat-value" id="stat-total-credits">$0</div>
        <div class="quick-stat-label">Credits Available</div>
      </div>
      <div class="quick-stat-card">
        <div class="quick-stat-value" id="stat-net-value">$0</div>
        <div class="quick-stat-label">Net Value</div>
      </div>
    </div>

    <!-- My Cards Section -->
    <section class="my-cards-section" id="my-cards-section">
      <h2>My Cards</h2>
      <div class="sort-selector" id="sort-selector">
        <label>Sort by:</label>
        <div class="sort-buttons">
          <button class="sort-btn active" data-sort="issuer" onclick="setSortOption('issuer')">Issuer</button>
          <button class="sort-btn" data-sort="fee" onclick="setSortOption('fee')">Annual Fee</button>
          <button class="sort-btn" data-sort="date" onclick="setSortOption('date')">Sign-Up Date</button>
        </div>
      </div>
      <div id="my-cards-list">
        <!-- User's selected cards will be shown here -->
      </div>
      <div class="save-actions">
        <div>
          <span class="save-status" id="save-status">Changes not saved</span>
          <p class="text-muted" style="font-size: 0.75rem; margin-top: 0.25rem;">Saving generates a backup code that's copied to your clipboard. Store it to restore your data later.</p>
        </div>
        <button class="btn btn-primary" id="save-btn" onclick="saveMyCards()">Save Changes</button>
      </div>

      <!-- Save/Restore Data (moved here from bottom) -->
      <div id="save-restore-ui" style="margin-top: 1.5rem;"></div>

      <!-- Auth Container -->
      <div id="auth-container" class="auth-container"></div>
    </section>

    <!-- Add Cards Section -->
    <section>
      <div class="my-cards-header">
        <h2 style="margin: 0;">Add Cards</h2>
        <div class="search-container">
          <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
          <input type="text" class="search-input" id="card-search" placeholder="Search cards..." oninput="filterCardSelector()">
        </div>
      </div>

      <div class="card-selector-grid" id="card-selector">
        <!-- All available cards will be listed here -->
      </div>

      <div style="text-align: center; margin-top: 1.5rem;">
        <a href="pages/cards.html#suggest" style="color: var(--text-secondary); font-size: 0.85rem; text-decoration: none;">
          Can't find your card? Suggest one →
        </a>
      </div>
    </section>

  </div>

  <script src="data/cards.js"></script>
  <script src="js/save-code.js"></script>
  <script src="js/card-visuals.js"></script>
  <script src="js/firebase-config.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/feedback.js"></script>
  <script>
    // State
    let selectedCards = [];
    let cardSignupDates = {};
    let hasUnsavedChanges = false;
    let expandedCardId = null; // Track which card's settings are open
    let currentSortOption = 'issuer'; // Sort option: 'issuer', 'fee', 'date'

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadSavedData();
      renderCardSelector();
      renderMyCards();
      updateQuickStats();

      // Initialize save/restore UI
      if (typeof CardMaxSave !== 'undefined') {
        CardMaxSave.renderSaveRestoreUI('save-restore-ui');
      }

      // Initialize auth
      if (typeof CardMaxAuth !== 'undefined') {
        CardMaxAuth.init();
      }
    });

    // Load saved data
    function loadSavedData() {
      const saved = localStorage.getItem('cardmax_user_cards');
      const savedDates = localStorage.getItem('cardmax_signup_dates');
      const savedSort = localStorage.getItem('cardmax_sort_option');

      if (saved) {
        selectedCards = JSON.parse(saved);
      }

      if (savedDates) {
        cardSignupDates = JSON.parse(savedDates);
      }

      if (savedSort) {
        currentSortOption = savedSort;
        updateSortButtons();
      }
    }

    // Save data
    function saveMyCards() {
      localStorage.setItem('cardmax_user_cards', JSON.stringify(selectedCards));
      localStorage.setItem('cardmax_signup_dates', JSON.stringify(cardSignupDates));

      hasUnsavedChanges = false;
      updateSaveStatus();

      // Sync to cloud if signed in
      if (typeof CardMaxAuth !== 'undefined' && CardMaxAuth.isSignedIn()) {
        CardMaxAuth.syncToCloud();
      }

      // Generate and copy backup code automatically
      if (typeof CardMaxSave !== 'undefined' && selectedCards.length > 0) {
        const code = CardMaxSave.generateBackupCode();
        navigator.clipboard.writeText(code).then(() => {
          CardMaxSave.showToast('Saved! Backup code copied to clipboard.');
          // Reload after short delay so user sees the toast
          setTimeout(() => window.location.reload(), 1500);
        }).catch(() => {
          // Fallback if clipboard fails
          CardMaxSave.showToast('Cards saved! Reloading...');
          setTimeout(() => window.location.reload(), 1000);
        });
      } else {
        // No cards to backup, just reload
        if (typeof CardMaxSave !== 'undefined') {
          CardMaxSave.showToast('Cards saved! Reloading...');
        }
        setTimeout(() => window.location.reload(), 1000);
      }
    }

    // Mark changes as unsaved
    function markUnsaved() {
      hasUnsavedChanges = true;
      updateSaveStatus();
    }

    // Update save status indicator
    function updateSaveStatus() {
      const status = document.getElementById('save-status');
      if (hasUnsavedChanges) {
        status.textContent = '● Changes not saved';
        status.classList.remove('saved');
      } else {
        status.textContent = '✓ All changes saved';
        status.classList.add('saved');
      }
    }

    // Set sort option
    function setSortOption(option) {
      currentSortOption = option;
      localStorage.setItem('cardmax_sort_option', option);
      updateSortButtons();
      renderMyCards();
    }

    // Update sort button active state
    function updateSortButtons() {
      const buttons = document.querySelectorAll('.sort-btn');
      buttons.forEach(btn => {
        if (btn.dataset.sort === currentSortOption) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }

    // Sort cards based on current option
    function sortCards(cardIds) {
      const cardsWithData = cardIds.map(id => {
        const card = CARDS_DATABASE.find(c => c.id === id);
        const signupDate = cardSignupDates[id] || {};
        return { id, card, signupDate };
      }).filter(item => item.card);

      switch (currentSortOption) {
        case 'issuer':
          // Sort by issuer name, then by card name
          cardsWithData.sort((a, b) => {
            const issuerCompare = a.card.issuer.localeCompare(b.card.issuer);
            if (issuerCompare !== 0) return issuerCompare;
            return a.card.name.localeCompare(b.card.name);
          });
          break;

        case 'fee':
          // Sort by annual fee (highest first)
          cardsWithData.sort((a, b) => b.card.annualFee - a.card.annualFee);
          break;

        case 'date':
          // Sort by month/day (calendar order), ignoring year
          // January at top, cards without dates at bottom
          cardsWithData.sort((a, b) => {
            const dateA = getCalendarDateValue(a.signupDate);
            const dateB = getCalendarDateValue(b.signupDate);
            // Cards without dates go to the end
            if (dateA === 0 && dateB === 0) return 0;
            if (dateA === 0) return 1;
            if (dateB === 0) return -1;
            return dateA - dateB; // January first
          });
          break;
      }

      return cardsWithData.map(item => item.id);
    }

    // Get calendar date value for sorting (month/day only, 0 if no month set)
    function getCalendarDateValue(signupDate) {
      if (!signupDate.month) return 0;
      const month = signupDate.month || 1;
      const day = signupDate.day || 1;
      return month * 100 + day;
    }

    // Filter card selector
    function filterCardSelector() {
      const query = document.getElementById('card-search').value.toLowerCase();
      const items = document.querySelectorAll('.card-selector-item');

      items.forEach(item => {
        const name = item.dataset.name.toLowerCase();
        const issuer = item.dataset.issuer.toLowerCase();
        if (name.includes(query) || issuer.includes(query)) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });
    }

    // Render card selector grid (only cards NOT in collection)
    function renderCardSelector() {
      const container = document.getElementById('card-selector');

      // Filter out cards already in collection, then sort by issuer
      const availableCards = CARDS_DATABASE
        .filter(card => !selectedCards.includes(card.id))
        .sort((a, b) => a.issuer.localeCompare(b.issuer));

      if (availableCards.length === 0) {
        container.innerHTML = `
          <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--text-secondary);">
            <p>You've added all available cards!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = availableCards.map(card => {
        const shortIssuer = getShortIssuer(card.issuer);
        const cardVisual = typeof CardVisuals !== 'undefined' ? CardVisuals.generate(card) : `<div class="card-color-bar" style="background: ${card.color}"></div>`;
        return `
          <div class="card-selector-item"
               data-id="${card.id}"
               data-name="${card.name}"
               data-issuer="${card.issuer}"
               onclick="toggleCardSelection('${card.id}')">
            ${cardVisual}
            <div class="card-details">
              <div class="card-name">${shortIssuer} ${getShortCardName(card.name)}</div>
              <div class="card-issuer">${card.issuer}</div>
              <div class="card-fee">$${card.annualFee}/year</div>
            </div>
            <div class="card-checkbox"></div>
          </div>
        `;
      }).join('');
    }

    // Get short issuer name
    function getShortIssuer(issuer) {
      const shortNames = {
        'Chase': 'Chase',
        'American Express': 'Amex',
        'Capital One': 'C1',
        'Citi': 'Citi',
        'Bank of America': 'BoA',
        'Wells Fargo': 'WF',
        'US Bank': 'USB',
        'Discover': 'Disc',
        'Cardless': 'Bilt'
      };
      return shortNames[issuer] || issuer;
    }

    // Get short card name (remove issuer prefix)
    function getShortCardName(name) {
      // Remove common prefixes
      return name
        .replace(/^Chase /, '')
        .replace(/^American Express /, '')
        .replace(/^Capital One /, '')
        .replace(/^Citi /, '')
        .replace(/^Bank of America /, '')
        .replace(/^Wells Fargo /, '')
        .replace(/^US Bank /, '')
        .replace(/^Discover /, '')
        .replace(/^Bilt /, '');
    }

    // Toggle card selection
    function toggleCardSelection(cardId) {
      const index = selectedCards.indexOf(cardId);
      if (index > -1) {
        selectedCards.splice(index, 1);
        delete cardSignupDates[cardId];
      } else {
        selectedCards.push(cardId);
      }

      // AUTO-SAVE immediately to localStorage
      localStorage.setItem('cardmax_user_cards', JSON.stringify(selectedCards));
      localStorage.setItem('cardmax_signup_dates', JSON.stringify(cardSignupDates));
      hasUnsavedChanges = false;

      // Auto-sync to cloud if signed in
      if (typeof CardMaxAuth !== 'undefined') CardMaxAuth.autoSync();

      renderCardSelector();
      renderMyCards();
      updateQuickStats();
      updateSaveStatus();
    }

    // Remove card from my cards
    function removeCard(cardId) {
      const index = selectedCards.indexOf(cardId);
      if (index > -1) {
        selectedCards.splice(index, 1);
        delete cardSignupDates[cardId];
      }

      // AUTO-SAVE immediately to localStorage
      localStorage.setItem('cardmax_user_cards', JSON.stringify(selectedCards));
      localStorage.setItem('cardmax_signup_dates', JSON.stringify(cardSignupDates));
      hasUnsavedChanges = false;

      // Auto-sync to cloud if signed in
      if (typeof CardMaxAuth !== 'undefined') CardMaxAuth.autoSync();

      renderCardSelector();
      renderMyCards();
      updateQuickStats();
      updateSaveStatus();
    }

    // Toggle date picker for a card
    function toggleDatePicker(cardId, event) {
      // Don't toggle if clicking on the remove button or date inputs
      if (event.target.closest('.action-btn') || event.target.closest('.date-row')) return;

      if (expandedCardId === cardId) {
        expandedCardId = null;
      } else {
        expandedCardId = cardId;
      }
      renderMyCards();
    }

    // Render my cards list
    function renderMyCards() {
      const container = document.getElementById('my-cards-list');
      const sortSelector = document.getElementById('sort-selector');

      if (selectedCards.length === 0) {
        sortSelector.style.display = 'none';
        container.innerHTML = `
          <div class="empty-state">
            <h3>No cards selected yet</h3>
            <p>Click on cards below to add them to your collection</p>
          </div>
        `;
        return;
      }

      sortSelector.style.display = 'flex';

      const months = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const days = [''];
      for (let d = 1; d <= 31; d++) {
        days.push(d);
      }
      const currentYear = new Date().getFullYear();
      const years = [''];
      for (let y = currentYear; y >= currentYear - 20; y--) {
        years.push(y);
      }

      // Sort cards based on current sort option
      const sortedCardIds = sortCards(selectedCards);

      container.innerHTML = sortedCardIds.map(cardId => {
        const card = CARDS_DATABASE.find(c => c.id === cardId);
        if (!card) return '';

        const signupDate = cardSignupDates[cardId] || {};
        const shortIssuer = getShortIssuer(card.issuer);
        const cardVisual = typeof CardVisuals !== 'undefined' ? CardVisuals.generate(card) : `<div class="card-color-bar" style="background: ${card.color}"></div>`;
        const hasDate = signupDate.month || signupDate.day || signupDate.year;
        const dateDisplay = hasDate
          ? `${months[signupDate.month] || ''}${signupDate.day ? ' ' + signupDate.day : ''}${signupDate.year ? ', ' + signupDate.year : ''}`.trim()
          : '';
        const isExpanded = expandedCardId === cardId;

        return `
          <div class="my-card-item ${isExpanded ? 'expanded' : ''}" onclick="toggleDatePicker('${cardId}', event)">
            <div class="card-actions">
              <button class="action-btn remove" onclick="removeCard('${cardId}')" title="Remove">×</button>
            </div>
            ${cardVisual}
            <div class="card-details">
              <div class="card-name">${shortIssuer} ${getShortCardName(card.name)}</div>
              <div class="card-meta">
                <span>$${card.annualFee}/yr</span>
                ${dateDisplay ? `<span>${dateDisplay}</span>` : '<span class="add-date-hint">+ Add date</span>'}
              </div>
            </div>
            <div class="date-row" style="display: ${isExpanded ? 'flex' : 'none'};">
              <label>Opened:</label>
              <select onchange="updateSignupDate('${cardId}', 'month', this.value)">
                ${months.map((m, i) => `<option value="${i}" ${signupDate.month === i ? 'selected' : ''}>${m || 'Mo'}</option>`).join('')}
              </select>
              <select onchange="updateSignupDate('${cardId}', 'day', this.value)">
                ${days.map(d => `<option value="${d}" ${signupDate.day == d ? 'selected' : ''}>${d || 'Day'}</option>`).join('')}
              </select>
              <select onchange="updateSignupDate('${cardId}', 'year', this.value)">
                ${years.map(y => `<option value="${y}" ${signupDate.year == y ? 'selected' : ''}>${y || 'Yr'}</option>`).join('')}
              </select>
            </div>
          </div>
        `;
      }).join('');

    }

    // Update signup date
    function updateSignupDate(cardId, field, value) {
      if (!cardSignupDates[cardId]) {
        cardSignupDates[cardId] = {};
      }

      cardSignupDates[cardId][field] = parseInt(value) || null;

      // AUTO-SAVE immediately to localStorage
      localStorage.setItem('cardmax_user_cards', JSON.stringify(selectedCards));
      localStorage.setItem('cardmax_signup_dates', JSON.stringify(cardSignupDates));
      hasUnsavedChanges = false;
      updateSaveStatus();

      // Auto-sync to cloud if signed in
      if (typeof CardMaxAuth !== 'undefined') CardMaxAuth.autoSync();

      // Re-render to update date display in subtitle
      renderMyCards();
    }

    // Update quick stats
    function updateQuickStats() {
      let totalFees = 0;
      let totalCredits = 0;

      selectedCards.forEach(cardId => {
        const card = CARDS_DATABASE.find(c => c.id === cardId);
        if (!card) return;

        totalFees += card.annualFee;

        card.credits.forEach(credit => {
          if (typeof credit.amount === 'number' && credit.type !== 'points') {
            totalCredits += credit.amount;
          }
        });
      });

      const netValue = totalCredits - totalFees;

      document.getElementById('stat-my-cards').textContent = selectedCards.length;
      document.getElementById('stat-annual-fees').textContent = '$' + totalFees.toLocaleString();
      document.getElementById('stat-total-credits').textContent = '$' + totalCredits.toLocaleString();
      document.getElementById('stat-net-value').textContent = (netValue >= 0 ? '+$' : '-$') + Math.abs(netValue).toLocaleString();
      document.getElementById('stat-net-value').style.color = netValue >= 0 ? 'var(--accent)' : 'var(--warning)';
    }
  </script>
</body>
</html>
